name: Sparrow SAST

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  sast:
    runs-on: [self-hosted, linux, x64]

    steps:
      - uses: actions/checkout@v4

      - name: Run Sparrow SAST
        shell: bash
        run: |
          WS="${GITHUB_WORKSPACE}"
          PASSWORD_FILE="${WS}/password.txt"
          ANALYSIS_FILE="${WS}/analysis.json"

          echo -n "${{ secrets.SPARROW_PASSWORD }}" > "$PASSWORD_FILE"

          cat <<EOF > "$ANALYSIS_FILE"
          {
            "type": "full",
            "profile": "${{ secrets.SPARROW_PROFILE }}",
            "targets": [
              {
                "type": "file",
                "path": ["$WS"],
                "extensions": ["*"],
                "basePath": "$WS"
              }
            ]
          }
          EOF

          CLI_PATH="/app/sparrow/bin/sparrow-cli"
          chmod +x "$CLI_PATH"

          "$CLI_PATH" create analysis \
            -k "${{ secrets.SPARROW_PROJECT_KEY }}" \
            -f "$ANALYSIS_FILE" \
            -s "${{ secrets.SPARROW_SERVER_URL }}" \
            -u "${{ secrets.SPARROW_USER }}" \
            -p "$PASSWORD_FILE"
